<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""/>
    <title>Spread Across State</title>
    <style>
        #map { position: fixed; top:0; bottom: 0; left: 0; right: 00;}
        .leaflet-container {
            background: #fff;
            outline: 0;
            width: 100%;
        }
        .map-container {
            background-color: #ddd;
        }
        .legend {
            text-align: left;
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        .info {
            padding: 6px 8px;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgb(0 0 0 / 20%);
            border-radius: 5px;
        }
    </style>
  </head>
  <body>

    <div class="map-container">
        <div id="map"></div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script> 
        
    <!-- <script src="./script.js"></script> -->
    <script>
        let postcode_totals;

        fetch('./data/postcode_totals.json')
            .then(response => response.json())
            .then(data => {
                postcode_totals = data
                postcodes = data.map(i => i.Postcode)
                console.log(postcodes)
                fetch('./data/postcode_map.geojson')
                    .then(response => response.json())
                    .then(data => {
                        data = data.features.map(postcode => {
                            if(postcodes.includes(postcode.properties.POA_CODE16)) {
                                postcode.properties.total = postcode_totals.filter(i => i.Postcode == postcode.properties.POA_CODE16)[0].n
                            } else {
                                postcode.properties.total = NaN
                            }
                            return postcode
                        })

                        let getColor = v => {
                            return  v > 1000 ? '#800026' :
                                    v > 500  ? '#BD0026' :
                                    v > 200  ? '#E31A1C' :
                                    v > 100  ? '#FC4E2A' :
                                    v > 50   ? '#FD8D3C' :
                                    v > 20   ? '#FEB24C' :
                                    v > 10   ? '#FED976' :
                                                '#FFEDA0';
                        }
                        let maxTotal = Math.max(...postcode_totals.map(i => i.n))
                        console.log(maxTotal)
                        let map = L.map('map').setView([147.0967,-36.0406 ], 13),
                        vector = L.geoJson(data, {
                            onEachFeature: (feature, layer) => {
                                let style;

                                

                                let zoomToFeature = (e) => {
                                    map.fitBounds(e.target.getBounds());
                                }

                                let highlightFeature = (e) => {
                                    let layer = e.target;

                                    layer.setStyle({
                                        weight: 3,
                                        color: '#777',
                                        dashArray: '',
                                        fillOpacity: 0.7
                                    });
                                    
                                    layer.bindTooltip("<div>Postcode:<b>" + feature.properties.POA_NAME16 + "</b><div>Total:<b>" + feature.properties.total + "</b></div></div>").openTooltip();

                                    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                                        layer.bringToFront();
                                    }

                                }

                                let resetHighlight = (e) => {
                                    let layer = e.target;
                                    layer.setStyle({
                                        fillColor: feature.properties.total ? getColor(feature.properties.total) : "#efefef",
                                        color: "#fff",
                                        weight: 1,
                                        fillOpacity: 1
                                    });
                                    // geojson.resetStyle(layer)
                                    layer.closeTooltip()
                                }


                                if(feature.properties.total)  {
                                    style = {
                                        // fillColor: "rgba(0, 0, 200, " + (feature.properties.total/maxTotal).toFixed(2)  + ")",
                                        // color: "rgba(0, 0, 200, " + (feature.properties.total/maxTotal).toFixed(2)  + ")"
                                        fillColor: getColor(feature.properties.total),
                                        // color: "#fff",
                                        // weight: 0.25
                                    }
                                } else {
                                    style = {
                                        fillColor: "#efefef",
                                        color: "#fff",                                 
                                    }
                                }
                                layer.setStyle(style)
                                // AREASQKM20: 256.3162
                //   console.log(feature.properties)
                                // layer.bindTooltip("<div>Postcode:<b>" + feature.properties.POA_NAME16 + "</b><div>Total:<b>" + feature.properties.total + "</b></div></div>").openTooltip();
                                // layer.on("click", (e, d) => {
                                //     // console.log(e.target.feature.properties.total)
                                // })
                                // layer.on("mouseover", (e, d) => {
                                //     layer.setStyle({
                                //         fillColor: "rgba(236, 88, 88, " + (e.target.feature.properties.total/maxTotal).toFixed(2)  + ")"
                                //     })
                                // })
                                // layer.on("mouseout", (e, d) => {
                                //     layer.setStyle({
                                //         fillColor: "#DCBCBC"
                                //     })
                                // })
                                layer.on({
                                    mouseover: highlightFeature,
                                    mouseout: resetHighlight,
                                    click: zoomToFeature
                                });

                            },
                            style: {
                                // color: "#EC5858",
                                // color: "#eee",
                                weight: 0.5,
                                // fillColor: "#FFF",
                                color: "#fff",
                                fillOpacity: 1
                            }
                        }).addTo(map); 
                        
                        let legend = L.control({position: 'bottomright'});

                        legend.onAdd = function (map) {

                            var div = L.DomUtil.create('div', 'info legend'),
                                grades = [0, 10, 20, 50, 100, 200, 500, 1000],
                                labels = [];

                            // loop through our density intervals and generate a label with a colored square for each interval
                            for (var i = 0; i < grades.length; i++) {
                                div.innerHTML +=
                                    '<i style="background-color:' + getColor(grades[i] + 1) + '"></i> ' +
                                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
                            }

                            return div;
                        };

                        legend.addTo(map);
                        map.fitBounds(vector.getBounds());
                        // vector.bindPopup(function (layer) {
                        //     return layer.feature.properties.description;
                        // }) 
                    })
                    .catch(error => console.log(error));
            })

        
       
    </script>
  </body>
</html>